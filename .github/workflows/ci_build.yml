name: CI

env:
  XCODE_VERSION: 14.3.1
  XCODEBUILD_DESTINATION: platform=iOS Simulator,name=iPhone 14,OS=16.4

on:
    push:
        branches:
        - master
        - dev

    pull_request:
        branches:
        - master
        - dev

jobs:
  Build:
    permissions: write-all
    runs-on: macos-13
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - uses: maxim-lobanov/setup-xcode@v1
      name: Set Xcode Version
      with:
        xcode-version: "${{ env.XCODE_VERSION }}"

    - name: "Test SDK versions"
      run: |
        xcodebuild -showsdks

    - name: "Xcode Build"
      uses: sersoft-gmbh/xcodebuild-action@v2
      with:
        project: Mlem.xcodeproj
        scheme: Mlem
        destination: "${{ env.XCODEBUILD_DESTINATION }}"
        action: build
        result-bundle-path: build_results.xcresult

    - uses: kishikawakatsumi/xcresulttool@v1
      name: Publish build results
      with:
        path: build_results.xcresult
        upload-bundles: never # Permission issues with uploading
        show-passed-tests: false
      if: success() || failure()
      # ^ This is important because the action will be run
      # even if the test fails in the previous step.

  Test:
    permissions: write-all
    runs-on: macos-13
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - uses: maxim-lobanov/setup-xcode@v1
      name: Set Xcode Version
      with:
        xcode-version: "${{ env.XCODE_VERSION }}"
      
    - name: "Test SDK versions"
      run: |
        xcodebuild -showsdks

    - name: "Xcode Test"
      uses: sersoft-gmbh/xcodebuild-action@v2
      with:
        project: Mlem.xcodeproj
        scheme: Mlem
        destination: "${{ env.XCODEBUILD_DESTINATION }}"
        action: test
        result-bundle-path: test_results.xcresult

    - uses: kishikawakatsumi/xcresulttool@v1
      name: Publish test results
      with:
        path: test_results.xcresult
        upload-bundles: never # Permission issues with uploading
      if: success() || failure()
      # ^ This is important because the action will be run
      # even if the test fails in the previous step.